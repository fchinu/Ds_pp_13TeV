# Efficiency Evaluation

## Configuration

### Required Configuration Files

In the `configs/` directory you will find the necessary configuration files for efficiency evaluation:

- `config_efficiency.yml` - Main configuration for efficiency evaluation
- `config_weights.yml` - Configuration for weight calculations (conditionally used)
- `cutset.yml` - Cut set configuration (from `../Projections_RawYields/configs/`)

### Conditional Configuration

The weights configuration is handled conditionally:
- If `apply: True` is found in the efficiency config, the weights config is populated and used
- If `apply: True` is not found, the weights config is cleared and the weights script is skipped

## Usage

### Basic Commands

```bash
# Run complete pipeline with default settings (NAME=OO)
make

# Run analysis for a specific trial
make NAME=PP

# Run analysis for different trial names
make NAME=OO
make NAME=PbPb

# Just setup directories and copy config files
make setup NAME=PP

# Run only weights calculation
make weight NAME=PP

# Run only efficiency evaluation (requires weights to be completed)
make efficiency NAME=PP
```

### Variables

- `NAME` - Trial name. Will set the output directory name (default: `OO`)

### Available Targets

- `all` - Run complete pipeline (setup → weight → efficiency)
- `setup` - Create directories and copy configuration files
- `weight` - Run weight calculations
- `efficiency` - Run efficiency evaluation (depends on weights)
- `clean-output` - Remove output files but keep configs
- `help` - Show help message with available targets and examples
- `debug` - Display all variable values for debugging

## What the Makefile Does

### 1. Setup Phase
- Creates output directory: `./[NAME]/`
- Copies configuration files to the trial directory
- **Automatically updates** paths in config files to point to correct output locations:
  - Updates `output_dir:` in efficiency config
  - Updates `directory:` in weights config (if weights are needed)
  - Updates `cutset:` paths in both configs
- **Conditionally handles weights config**:
  - If `apply: True` found in efficiency config: populates weights config with actual content
  - If `apply: True` not found: creates empty weights config file

### 2. Weights Phase
- **Conditionally runs** `produce_mult_weights.py`:
  - If weights config is non-empty: runs the weights script
  - If weights config is empty: skips execution entirely
- Creates a completion marker file (`weights.done`)

### 3. Efficiency Phase
- Runs `evaluate_efficiency_sparse.py` with the efficiency configuration
- Uses the results from the weights phase (if applicable)
- Creates a completion marker file (`efficiency.done`)

## Configuration Dependencies

The efficiency evaluation depends on:
- **Cutset configuration**: Used by both weights and efficiency scripts
- **Weights configuration**: Only used if `apply: True` is set in efficiency config
- **Efficiency configuration**: Controls the main analysis and determines if weights are needed

## Cleaning Up

```bash
# Remove output files but keep config files
make clean-output NAME=PP

# This removes: *.done, *.root, *.pdf, *.png, *.parquet files
```

## Examples

### Running Multiple Trials

```bash
# Run efficiency evaluation for different trials
make NAME=OO
make NAME=PP
make NAME=PbPb
```

### Conditional Weights Behavior

```bash
# If your config_efficiency.yml contains "apply: True"
make NAME=test
# → Weights config is populated and weights script runs

# If your config_efficiency.yml does NOT contain "apply: True"
make NAME=test
# → Weights config is cleared and weights script is skipped
```

### Development Workflow

```bash
# Setup and check configuration
make setup NAME=dev
# → Check the generated config files in ./dev/

# Run individual steps
make weight NAME=dev
make efficiency NAME=dev

# Debug variable values
make debug NAME=dev

# Clean and re-run
make clean-output NAME=dev
make NAME=dev
```

### Debugging

```bash
# Check variable values
make debug NAME=PP

# Get help
make help
```

## Output Structure

After running the complete pipeline, your directory structure will look like:

```
./efficiency/[NAME]/
├── config_efficiency.yml    # Modified efficiency config
├── config_weights.yml       # Weights config (populated or empty)
├── cutset.yml              # Cutset configuration
├── weights.done            # Completion marker
├── efficiency.done         # Completion marker
└── [output files]          # Generated by the scripts
```

## Notes

- Configuration files are automatically modified to use correct output directories
- The weights system is fully conditional - no unnecessary processing when weights aren't needed
- All paths are converted to absolute paths to ensure reliability
- The pipeline uses completion markers (`.done` files) to track progress and avoid redundant work